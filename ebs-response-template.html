<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>BD Tools — EBS Response Template</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
:root{
  --bg:#f4f7fb;
  --card:#ffffff;
  --muted:#64748b;
  --accent:#4d148c;
  font-family: Inter, system-ui, sans-serif;
}
body{margin:0;background:var(--bg);min-height:100vh;display:flex;flex-direction:column;}
header{background:var(--accent);color:#fff;padding:16px 28px;}
.main{flex:1;padding:30px;display:flex;justify-content:center;}
.message-box{background:#fff;padding:30px;border-radius:12px;width:100%;max-width:1600px;}
.control-group{display:flex;gap:12px;align-items:center;margin-bottom:20px;flex-wrap:wrap;}
select{padding:10px 14px;border-radius:6px;border:1px solid #ccc;min-width:260px;}
.response-item{border:1px solid #e5e7eb;border-radius:10px;padding:16px;margin-bottom:16px;background:#f9fafb;}
.response-text{white-space:pre-wrap;line-height:1.6;background:#fff;padding:12px;border-left:4px solid var(--accent);border-radius:6px;}
.copy-btn{margin-top:10px;padding:6px 12px;background:var(--accent);color:#fff;border:none;border-radius:6px;cursor:pointer;}
.loading-message{color:#64748b;font-style:italic;}
.error-message{background:#fee2e2;color:#991b1b;padding:10px;border-radius:6px;margin-bottom:10px;}
</style>
</head>

<body>

<header>
  <strong>EBS Response Template</strong>
</header>

<div class="main">
  <div class="message-box">
    <div id="loadingStatus" class="loading-message">Loading response templates...</div>
    <div id="errorStatus"></div>

    <div class="control-group" id="controlGroup" style="display:none;">
      <label><strong>Concern:</strong></label>
      <select id="concernSelect">
        <option value="">-- Select Concern --</option>
      </select>

      <label><strong>Type:</strong></label>
      <select id="typeSelect" disabled>
        <option value="">-- Select Type --</option>
      </select>
    </div>

    <div id="responseContainer"></div>
  </div>
</div>

<script>
let ALL_TEMPLATES = [];

function populateConcerns(data){
  const select = document.getElementById('concernSelect');
  const concerns = [...new Set(data.map(r => r.Concern).filter(Boolean))].sort();
  concerns.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c;
    opt.textContent = c;
    select.appendChild(opt);
  });
}

function populateTypes(concern){
  const typeSelect = document.getElementById('typeSelect');
  typeSelect.innerHTML = '<option value="">-- Select Type --</option>';
  typeSelect.disabled = true;

  if(!concern) return;

  const types = [...new Set(
    ALL_TEMPLATES
      .filter(t => t.Concern === concern)
      .map(t => t.Type)
      .filter(Boolean)
  )].sort();

  types.forEach(t => {
    const opt = document.createElement('option');
    opt.value = t;
    opt.textContent = t;
    typeSelect.appendChild(opt);
  });

  typeSelect.disabled = false;
}

function displayResponse(concern, type){
  const container = document.getElementById('responseContainer');
  container.innerHTML = '';

  if(!concern || !type) return;

  const match = ALL_TEMPLATES.find(t => t.Concern === concern && t.Type === type);

  if(!match){
    container.innerHTML = '<div class="loading-message">No template found.</div>';
    return;
  }

  container.innerHTML = `
    <div class="response-item">
      <div><strong>${match.Type}</strong></div>
      <div class="response-text">${match['Response Template']}</div>
      <button class="copy-btn" onclick="copyToClipboard(this)">Copy Template</button>
    </div>
  `;
}

function copyToClipboard(btn){
  const text = btn.previousElementSibling.textContent;
  navigator.clipboard.writeText(text);
  btn.textContent = "Copied!";
  setTimeout(() => btn.textContent = "Copy Template", 1500);
}

document.getElementById('concernSelect').addEventListener('change', e => {
  const concern = e.target.value;
  populateTypes(concern);
  document.getElementById('responseContainer').innerHTML = '';
});

document.getElementById('typeSelect').addEventListener('change', e => {
  displayResponse(
    document.getElementById('concernSelect').value,
    e.target.value
  );
});

fetch("ebs-response.ods")
.then(res => res.arrayBuffer())
.then(data => {
  const workbook = XLSX.read(data, { type: 'array' });
  const sheet = workbook.Sheets[workbook.SheetNames[0]];
  const rows = XLSX.utils.sheet_to_json(sheet, { defval: "" });

  ALL_TEMPLATES = rows
    .map(r => ({
      Concern: r['Concern'],
      Type: r['Type'],
      'Response Template': r['Response Template']
    }))
    .filter(r => r.Concern && r.Type && r['Response Template']);

  populateConcerns(ALL_TEMPLATES);

  document.getElementById('loadingStatus').style.display = 'none';
  document.getElementById('controlGroup').style.display = 'flex';
})
.catch(err => {
  document.getElementById('loadingStatus').style.display = 'none';
  document.getElementById('errorStatus'].innerHTML =
    '<div class="error-message">❌ ' + err.message + '</div>';
});
</script>

</body>
</html>
