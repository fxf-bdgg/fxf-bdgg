<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>BD Tools — EBS Response</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
:root{
  --bg:#f4f7fb;
  --card:#ffffff;
  --muted:#64748b;
  --accent:#4d148c;
  --accent-dark:#3a0f6b;
  font-family: Inter, ui-sans-serif, system-ui;
}
*{box-sizing:border-box;}
body{margin:0;background:linear-gradient(180deg,var(--bg),#eef6ff);min-height:100vh;display:flex;flex-direction:column;}

header{
  background:var(--accent);
  color:white;
  padding:16px 28px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.nav-tabs{display:flex;gap:30px;}
.tab{color:white;text-decoration:none;font-weight:600;}
.tab.active::after{content:"";display:block;height:3px;background:#ff6600;border-radius:3px;margin-top:4px;}

.main{flex:1;padding:40px;display:flex;justify-content:center;}
.message-box{
  background:white;
  padding:40px;
  border-radius:14px;
  box-shadow:0 10px 30px rgba(0,0,0,0.08);
  width:100%;
  max-width:1400px;
}

.select-row{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px;}
select, textarea{
  width:100%;
  padding:12px 14px;
  border-radius:8px;
  border:1px solid #e2e8f0;
  font-size:15px;
}

textarea{min-height:180px;resize:vertical;}

.btn{
  background:var(--accent);
  color:white;
  border:none;
  padding:10px 18px;
  border-radius:8px;
  cursor:pointer;
  font-weight:600;
}
.btn:hover{background:var(--accent-dark);}

.note-box{
  margin-top:10px;
  background:#f8fafc;
  border-left:5px solid var(--accent);
  padding:12px;
  border-radius:6px;
  color:#334155;
  font-size:14px;
}

footer{background:var(--accent);color:white;padding:16px;text-align:center;}
</style>
</head>
<body>

<header>
  <div style="display:flex;gap:40px;align-items:center;">
    <a href="index.html"><img src="fedex.png" style="height:40px"></a>
    <nav class="nav-tabs">
      <a href="index.html" class="tab">Home</a>
      <a href="case-directory.html" class="tab">Case Directory</a>
      <a href="ebs-response-template.html" class="tab active">EBS Response</a>
    </nav>
  </div>
</header>

<div class="main">
  <div class="message-box">
    <h1 style="color:#4d148c;">EBS Response</h1>
    <p>Select the concern and type to generate the correct response template.</p>

    <div class="select-row">
      <select id="concernSelect">
        <option value="">Select Concern</option>
      </select>

      <select id="typeSelect" disabled>
        <option value="">Select Type</option>
      </select>
    </div>
    
    <div style="margin-bottom:12px;">
  <strong>Description</strong>
  <div id="descBox" style="margin-top:6px; padding:10px; background:#f8fafc; border-left:4px solid #4d148c; border-radius:6px; color:#334155;"></div>
</div>

    <label><strong>Response Template</strong></label>
    <textarea id="responseBox" readonly></textarea>

    <button class="btn" onclick="copyResponse()">
      <i class="fa-regular fa-copy"></i> Copy Response
    </button>

    <div id="noteBox" class="note-box" style="display:none;"></div>
  </div>
</div>

<footer>© 2025 EBS Operations</footer>

<script>
let DATA = [];

function normalizeRows(rows) {
  let lastConcern = "";
  let lastDesc = "";

  return rows.map(r => {
    r.Concern = (r.Concern || "").trim();
    r.Description = (r.Description || "").trim();
    r.Type = (r.Type || "").trim();
    r["Response Template"] = (r["Response Template"] || "").trim();
    r.Note = (r.Note || "").trim();

    if (r.Concern) lastConcern = r.Concern;
    else r.Concern = lastConcern;

    if (r.Description) lastDesc = r.Description;
    else r.Description = lastDesc;

    return r;
  });
}

fetch("ebs-response.ods")
  .then(res => res.arrayBuffer())
  .then(buf => {
    const wb = XLSX.read(buf, { type: "array" });
    const sheet = wb.Sheets[wb.SheetNames[0]];

    // FORCE column order mapping (fixes broken headers from merged cells)
    const raw = XLSX.utils.sheet_to_json(sheet, {
      defval: "",
      header: ["Concern", "Description", "Type", "Response Template", "Note"],
      range: 1
    });

    DATA = normalizeRows(raw);

    const concerns = [...new Set(DATA.map(r => r.Concern).filter(Boolean))].sort();
    const concernSelect = document.getElementById("concernSelect");

    concernSelect.innerHTML = `<option value="">Select Concern</option>`;
    concerns.forEach(c => {
      const opt = document.createElement("option");
      opt.value = c;
      opt.textContent = c;
      concernSelect.appendChild(opt);
    });

    console.log("Loaded rows:", DATA); // debug
  })
  .catch(err => {
    console.error(err);
    alert("Failed to load ebs-response.ods");
  });

document.getElementById("concernSelect").addEventListener("change", function () {
  const concern = this.value;
  const typeSelect = document.getElementById("typeSelect");
  const responseBox = document.getElementById("responseBox");
  const noteBox = document.getElementById("noteBox");
  const descBox = document.getElementById("descBox");

  typeSelect.innerHTML = `<option value="">Select Type</option>`;
  responseBox.value = "";
  noteBox.style.display = "none";
  descBox.textContent = "";

  if (!concern) {
    typeSelect.disabled = true;
    return;
  }

  const rows = DATA.filter(r => r.Concern === concern);

  if (!rows.length) {
    alert("No rows matched this concern. Check spacing in ODS.");
    return;
  }

  descBox.textContent = rows[0].Description || "";

  const types = [...new Set(rows.map(r => r.Type).filter(Boolean))].sort();

  types.forEach(t => {
    const opt = document.createElement("option");
    opt.value = t;
    opt.textContent = t;
    typeSelect.appendChild(opt);
  });

  typeSelect.disabled = false;
});

document.getElementById("typeSelect").addEventListener("change", function () {
  const concern = document.getElementById("concernSelect").value;
  const type = this.value;

  const match = DATA.find(r => r.Concern === concern && r.Type === type);

  if (!match) {
    alert("Template not found. This usually means spacing mismatch in ODS.");
    return;
  }

  document.getElementById("responseBox").value = match["Response Template"] || "";

  const noteBox = document.getElementById("noteBox");
  if (match.Note) {
    noteBox.style.display = "block";
    noteBox.textContent = "Note: " + match.Note;
  } else {
    noteBox.style.display = "none";
  }
});

function copyResponse() {
  const text = document.getElementById("responseBox").value;
  if (!text) return alert("No response to copy.");
  navigator.clipboard.writeText(text).then(() => alert("Copied!"));
}
</script>
</body>
</html>
