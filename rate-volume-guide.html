<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Rate & Volume Quote Guide</title>

<style>
/* ===== SAME STYLE AS CLASS UPDATE ===== */
:root{
  --bg:#f4f7fb;
  --card:#ffffff;
  --muted:#64748b;
  --accent:#4d148c;
  --accent-2:#ff6600;
  font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  color:#0f172a;
}
*{box-sizing:border-box}
body{margin:0;background:linear-gradient(180deg,var(--bg),#eef6ff);display:flex;flex-direction:column;min-height:100vh;}
header, footer{background:var(--accent);color:white;padding:16px 28px;}
header h1, footer p{margin:0;font-weight:600;}
.container{max-width:1400px;margin:0 auto;display:grid;grid-template-columns:1fr 1fr 420px;gap:20px;align-items:start;padding:28px 0;flex:1}
.card{background:var(--card);border-radius:12px;padding:18px;box-shadow:0 8px 28px rgba(2,6,23,0.06);overflow:hidden;opacity:0;transform:translateY(20px)}
h1{margin:0;font-size:22px;color:var(--accent)}
p.lead{margin:6px 0 14px;color:var(--muted);font-size:13px}
.progress-container{display:flex;align-items:center;gap:10px;margin:14px 0}
.progress-bar{flex:1;height:10px;background:#e2e8f0;border-radius:999px;overflow:hidden}
.progress-fill{height:100%;width:0%;background:var(--accent);transition:width .3s}
.progress-text{font-size:13px;color:var(--muted)}
.node{padding:12px;border-radius:10px;border:1px solid rgba(3,7,18,0.05);background:linear-gradient(180deg,#ffffff,#fbfeff);margin:10px 0;min-height:64px}
.choice-list{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
.choice{padding:8px 12px;border-radius:999px;background:#eef8f7;border:1px solid rgba(4,20,20,0.03);cursor:pointer;font-weight:600}
.choice:hover{background:#e0f2fe}
.path{margin-top:12px;padding:10px;border-radius:10px;background:#f8fafc;border:1px dashed rgba(3,7,18,0.04);font-size:13px}
.path strong{color:var(--accent)}
.result{margin-top:12px;padding:12px;border-radius:10px;background:#e6fbfb;border-left:4px solid var(--accent-2);animation:fadeIn .4s ease-in;min-height:56px}
.note{margin-top:6px;font-size:13px;color:var(--muted);font-style:italic}
.controls{display:flex;gap:8px;margin-top:12px}
button{background:var(--accent);color:white;border:none;padding:9px 12px;border-radius:9px;cursor:pointer;font-weight:600}
button.secondary{background:#fff;color:var(--accent);border:1px solid #ccc}
.output-card{margin-top:16px;padding:14px;border-radius:10px;background:#fff;box-shadow:0 4px 12px rgba(0,0,0,.05);animation:fadeIn .45s ease-in;position:relative}
.output-header{font-weight:700;color:#000;display:flex;justify-content:space-between;align-items:center}
.output-box{padding:10px;border-left:4px solid var(--accent-2);background:#f8fafc;border-radius:8px;white-space:pre-wrap;font-size:11px}
.copy-btn{background:var(--accent);color:white;border:none;padding:6px 10px;margin-top:10px;border-radius:6px;cursor:pointer;font-size:13px}
.copy-btn:hover{opacity:.85}

@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
@keyframes cardFadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:none}}
@keyframes logoFlyIn{from{opacity:0;transform:translateX(-50px) scale(.8)}to{opacity:1;transform:none}}

header img{opacity:0;animation:logoFlyIn 1s ease-out forwards}
header{position:relative;overflow:hidden}
header::after{content:"";position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(120deg,#4d148c,#ff6600,#4d148c);transform:skewX(-20deg);animation:sweep 1s ease-out forwards;opacity:.2}
@keyframes sweep{to{left:100%}}
@media(max-width:1200px){.container{grid-template-columns:1fr}}
.edit-icon{cursor:pointer;font-size:14px;margin-left:6px;color:var(--accent)}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.45);align-items:center;justify-content:center;z-index:1000}
.modal-content{background:#fff;padding:25px;border-radius:12px;min-width:500px;max-width:600px}
textarea{resize:none;width:100%;min-height:120px;padding:10px;border-radius:8px;border:1px solid #d1d5db;margin-top:10px}
</style>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>

<body>

<header style="display:flex;align-items:center;justify-content:space-between;">
  <div style="display:flex;align-items:center;gap:12px;">
    <a href="index.html">
      <img src="fedex.png" alt="FedEx Logo" style="height:40px;">
    </a>
    <h1>Rate & Volume Quote Guide</h1>
  </div>
  <button onclick="window.location.href='index.html'">Main Page</button>
</header>

<div class="container">
  <div class="card">
    <h1>Rate & Volume Quote Flow</h1>
    <p class="lead">Follow the steps below to determine the correct action for Rate and Volume Quote requests.</p>

    <div class="progress-container">
      <div class="progress-bar"><div id="progressFill" class="progress-fill"></div></div>
      <div id="progressText" class="progress-text">Not started</div>
    </div>

    <div id="flowArea" class="node"></div>

    <div class="controls">
      <button id="goBackBtn" class="secondary" style="display:none;">‚Üê Go Back</button>
      <button id="startOverBtn" class="secondary" style="display:none;">Start Over</button>
    </div>
  </div>

  <div class="card">
    <div class="node"><strong>Selected Path</strong><div id="selectedPath" class="path">No steps selected yet.</div></div>
    <div class="node"><strong>Recommended Action</strong><div id="recommendation" class="result">No recommendation yet.</div></div>
  </div>

<div class="card" id="suggestedPanel" style="display:none;">
    <div class="output-card">
      <div class="output-header">Suggested Comment <span class="edit-icon" onclick="attemptEdit('comment')">‚úèÔ∏è</span></div>
      <div id="suggestedComment" class="output-box"></div>
    </div>
    <div class="output-card">
      <div class="output-header">Possible CORR CODE <span class="edit-icon" onclick="attemptEdit('corr')">‚úèÔ∏è</span></div>
      <div id="suggestedCorrCode" class="output-box"></div>
    </div>
    <div class="output-card">
      <div class="output-header">Suggested Email <span class="edit-icon" onclick="attemptEdit('email')">‚úèÔ∏è</span></div>
      <div id="suggestedEmail" class="output-box"></div>
      <button class="copy-btn" id="copyEmailBtn">üìã Copy</button>
    </div>
  </div>
</div>

<footer><p>¬© 2025 EBS Operations</p></footer>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyDjaMdeh0Cgx00hzDyZOi54fDkR81wnxJU",
  authDomain:"bdgg-database.firebaseapp.com",
  projectId:"bdgg-database"
});
const db=firebase.firestore();
const COLLECTION="rate_volume_templates"; // NEW collection

let path=[],historyStack=[],currentFinalRecommendation="";

function escapeHtml(t){return t?t.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])):"";}
function docIdFromText(t){return t.trim().toLowerCase().replace(/\s+/g,"_");}
function getDocId(t,type){return `${docIdFromText(t)}_${type}`;}

const NODES = {

/* ================= INTRO ================= */

rate_volume_intro: {
  text: "What quote is noted per BOL?",
  choices: [
    { label: "LTL Quote", next: "ltl_noted_check" },
    { label: "Volume Quote", next: "volume_noted_check" }
  ]
},

/* ================= LTL FLOW ================= */

ltl_noted_check: {
  text: "Is the LTL Rate Quote noted on BOL?",
  choices: [
    { label: "Yes", next: "check_capl_keyword" },
    { label: "No", next: "ltl_not_noted_result" }
  ]
},

ltl_not_noted_result: {
  text: "Advise customer that LTL rate quote cannot be applied since not noted on BOL. See sample templates response on OS.",
  choices: []
},

check_capl_keyword: {
  text: "Check if Pro has CAPL keyword.",
  choices: [
    { label: "Yes", next: "move_to_inspection_review" },
    { label: "No", next: "class_match_check" }
  ]
},

move_to_inspection_review: {
  text: "Move to Inspection Review.",
  choices: []
},

class_match_check: {
  text: "Access the LTL Rate Quote ID in ACCOPS. Is the CLASS match on the FBC/FBI?",
  choices: [
    { label: "Yes", next: "weight_match_check" },
    { label: "No", next: "pro_inspected_check" }
  ]
},

pro_inspected_check: {
  text: "Is the Pro inspected?",
  choices: [
    { label: "Yes", next: "reclass_result" },
    { label: "No", next: "update_class_per_bol" }
  ]
},

reclass_result: {
  text: "Advise customer that quote cannot be applied due to reclassification since the shipment was inspected. If disputing re-class, clone the case and move parent case to Inspection Review.",
  choices: []
},

update_class_per_bol: {
  text: "Update class per BOL. Does rate match in ACCOPS after update?",
  choices: [
    { label: "Yes", next: "invoice_updated_result" },
    { label: "No", next: "weight_match_check" }
  ]
},

weight_match_check: {
  text: "Does the weight in ACCOPS match the Pro?",
  choices: [
    { label: "Yes", next: "zip_match_check" },
    { label: "No", next: "reweigh_check" }
  ]
},

reweigh_check: {
  text: "Was the Pro reweighed?",
  choices: [
    { label: "Yes", next: "reweigh_result" },
    { label: "No", next: "update_weight_per_bol" }
  ]
},

reweigh_result: {
  text: "Advise customer that quote cannot be applied due to new reweighed weight. If disputing, clone case and move parent case to Reweigh Review.",
  choices: []
},

update_weight_per_bol: {
  text: "Update weight per BOL. Does rate match in ACCOPS after update?",
  choices: [
    { label: "Yes", next: "invoice_updated_result" },
    { label: "No", next: "zip_match_check" }
  ]
},

zip_match_check: {
  text: "Do shipper and consignee zip codes match ACCOPS?",
  choices: [
    { label: "Yes", next: "debtor_match_check" },
    { label: "No", next: "zip_mismatch_result" }
  ]
},

zip_mismatch_result: {
  text: "Advise customer that quote cannot be applied due to different pickup/delivery zip code than quoted.",
  choices: []
},

debtor_match_check: {
  text: "Does the debtor on ACCOPS match the Pro?",
  choices: [
    { label: "Yes", next: "accessorial_check" },
    { label: "No", next: "billing_correct_check" }
  ]
},

billing_correct_check: {
  text: "Is the Pro billed correctly per BOL?",
  choices: [
    { label: "Yes", next: "billing_updated_result" },
    { label: "No", next: "update_bill_autorate" }
  ]
},

billing_updated_result: {
  text: "Billing updated to correct party per BOL.",
  choices: []
},

update_bill_autorate: {
  text: "Update bill per BOL then autorate. If rate matches, advise customer. If not, move to Pricing.",
  choices: []
},

accessorial_check: {
  text: "Do linehaul and fuel match the quote ID?",
  choices: [
    { label: "Yes", next: "invoice_rated_correctly" },
    { label: "No", next: "service_level_check" }
  ]
},

invoice_rated_correctly: {
  text: "Advise customer invoice is rated correctly per quote ID noted on BOL.",
  choices: []
},

service_level_check: {
  text: "What is the current service level?",
  choices: [
    { label: "Economy", next: "move_to_pricing_result" },
    { label: "Priority", next: "attempt_update_economy" }
  ]
},

attempt_update_economy: {
  text: "Attempt update to Economy. Does rate match after update?",
  choices: [
    { label: "Yes", next: "service_updated_success" },
    { label: "No", next: "move_to_pricing_result" }
  ]
},

service_updated_success: {
  text: "Proceed with updating service level to Economy and advise customer that quote ID has been applied.",
  choices: []
},

invoice_updated_result: {
  text: "Invoice updated to apply correct rate per quote ID noted on BOL.",
  choices: []
},

move_to_pricing_result: {
  text: "Move case to Pricing 10 Pros or less subqueue due to rate mismatch per quote noted on BOL.",
  choices: []
},

/* ================= VOLUME FLOW ================= */

volume_noted_check: {
  text: "Is the Volume quote noted on BOL?",
  choices: [
    { label: "Yes", next: "volume_minimum_check" },
    { label: "No", next: "customer_requested_tls_check" }
  ]
},

customer_requested_tls_check: {
  text: "Did customer request Volume/TLS rate to apply?",
  choices: [
    { label: "Yes", next: "pull_volume_quote" },
    { label: "No", next: "tls_apply_result" }
  ]
},

tls_apply_result: {
  text: "Advise customer that TLS rate will apply as charge fee per FXF 100 Rules Tariff Item 759.",
  choices: []
},

volume_minimum_check: {
  text: "Does shipment meet minimum 2,500 lbs or 7 linear feet?",
  choices: [
    { label: "Yes", next: "pull_volume_quote" },
    { label: "No", next: "volume_below_minimum_result" }
  ]
},

volume_below_minimum_result: {
  text: "Volume Quote should not apply if below 2,500 lbs or 7 linear ft. Advise customer.",
  choices: []
},

pull_volume_quote: {
  text: "Do origin and destination zip codes (or service center IDs) match the Volume quote?",
  choices: [
    { label: "Yes", next: "shipment_date_check" },
    { label: "No", next: "volume_zip_mismatch_result" }
  ]
},

volume_zip_mismatch_result: {
  text: "Advise customer that Volume quote cannot apply due to origin/destination zip mismatch.",
  choices: []
},

shipment_date_check: {
  text: "Is shipment date within quote effective date range?",
  choices: [
    { label: "Yes", next: "volume_weight_linear_check" },
    { label: "No", next: "volume_date_outside_result" }
  ]
},

volume_date_outside_result: {
  text: "Advise customer shipment date falls outside effective quote date.",
  choices: []
},

volume_weight_linear_check: {
  text: "Is weight and linear feet within quoted range?",
  choices: [
    { label: "Yes", next: "apply_volume_quote" },
    { label: "No", next: "overflow_charges_result" }
  ]
},

overflow_charges_result: {
  text: "Quote applies plus overflow charges. Calculate overflow using overflow calculator.",
  choices: []
},

apply_volume_quote: {
  text: "Access Volume quote application and apply Volume quote.",
  choices: []
}

};

function renderNode(node,key="rate_volume_intro"){
  const flowArea=document.getElementById("flowArea");
  const panel=document.getElementById("suggestedPanel");
  const progressFill=document.getElementById("progressFill");
  const progressText=document.getElementById("progressText");

  flowArea.innerHTML="";
  if(!node) return;

  if(!node.choices.length){
    currentFinalRecommendation=node.text;
    recommendation.innerHTML=`<strong>${escapeHtml(node.text)}</strong>`;
    generateSuggested(node.text);
  } else {
    currentFinalRecommendation="";
    recommendation.innerText="No recommendation yet.";
    panel.style.display="none";
  }

  const q=document.createElement("div");
  q.innerHTML=`<strong>${escapeHtml(node.text)}</strong>`;
  flowArea.appendChild(q);

  if(node.choices.length){
    const list=document.createElement("div");
    list.className="choice-list";
    node.choices.forEach(c=>{
      const btn=document.createElement("div");
      btn.className="choice";
      btn.textContent=c.label;
      btn.onclick=()=>{
        historyStack.push({key,path:[...path]});
        path.push({question:node.text,answer:c.label});
        renderNode(NODES[c.next],c.next);
        updateSelectedPath();
      };
      list.appendChild(btn);
    });
    flowArea.appendChild(list);
  }

  if(key==="rate_volume_intro"){
    progressFill.style.width="0%";
    progressText.textContent="Not started";
  } else {
    const s=Math.max(1,path.length);
    progressFill.style.width=Math.min(s*20,100)+"%";
    progressText.textContent=`Step ${s}`;
  }

  goBackBtn.style.display=historyStack.length && key!=="rate_volume_intro"?"inline-block":"none";
  startOverBtn.style.display=key!=="rate_volume_intro"?"inline-block":"none";
}

function updateSelectedPath(){
  selectedPath.innerHTML=path.length?
    path.map((p,i)=>`<strong>Step ${i+1}:</strong> ${escapeHtml(p.question)} ‚Üí <strong><em>${escapeHtml(p.answer)}</em></strong>`).join("<br>")
    :"No steps selected yet.";
}

async function generateSuggested(finalText){
  const panel=document.getElementById("suggestedPanel");
  for(const type of ["comment","email","corr"]){
    const ref=db.collection(COLLECTION).doc(getDocId(finalText,type));
    const snap=await ref.get();
    if(!snap.exists) await ref.set({text:"",type});
    const val=snap.exists?(snap.data().text||""):"";
    if(type==="comment") suggestedComment.innerText=val;
    if(type==="email") suggestedEmail.innerText=val;
    if(type==="corr") suggestedCorrCode.innerText=val;
  }
  panel.style.display="block";
}

goBackBtn.onclick=()=>{if(historyStack.length){const last=historyStack.pop();path=last.path||[];renderNode(NODES[last.key],last.key);updateSelectedPath();}};
startOverBtn.onclick=()=>{path=[];historyStack=[];currentFinalRecommendation="";selectedPath.textContent="No steps selected yet";suggestedPanel.style.display="none";renderNode(NODES.rate_volume_intro,"rate_volume_intro");};

renderNode(NODES.rate_volume_intro,"rate_volume_intro");

window.addEventListener('load',()=>{
  document.querySelectorAll('.card').forEach((c,i)=>{
    c.style.animation=`cardFadeIn .6s ease-out forwards`;
    c.style.animationDelay=`${1+i*.15}s`;
  });
});


let currentEditType="";

function attemptEdit(type){
  currentEditType=type;
  document.getElementById("passwordModal").style.display="flex";
}

function closePasswordModal(){
  document.getElementById("passwordModal").style.display="none";
}

function checkPassword(){
  if(document.getElementById("adminPassword").value==="admin"){
    closePasswordModal();
    openEditModal();
  }else{
    alert("Incorrect password");
  }
}

function openEditModal(){
  const map={
    comment:"suggestedComment",
    email:"suggestedEmail",
    corr:"suggestedCorrCode"
  };

  document.getElementById("editTextarea").value=
    document.getElementById(map[currentEditType]).innerText;

  document.getElementById("modalTitle").innerText=
    "Edit "+currentEditType.toUpperCase();

  document.getElementById("editModal").style.display="flex";
}

function closeEditModal(){
  document.getElementById("editModal").style.display="none";
}

async function saveEdit(){
  const textarea = document.getElementById("editTextarea");
  const saveBtn = document.querySelector("#editModal button");
  const val = textarea.value.trim();

  if(!val){
    alert("Cannot save empty text");
    return;
  }

  try{
    // Show saving state
    saveBtn.disabled = true;
    const originalText = saveBtn.innerText;
    saveBtn.innerText = "Saving...";

    const ref = db.collection(COLLECTION)
      .doc(getDocId(currentFinalRecommendation,currentEditType));

    await ref.set({text:val,type:currentEditType});

    // Update UI immediately
    document.getElementById(
      currentEditType==="comment"?"suggestedComment":
      currentEditType==="email"?"suggestedEmail":"suggestedCorrCode"
    ).innerText = val;

    // Restore button
    saveBtn.innerText = originalText;
    saveBtn.disabled = false;

    closeEditModal();
    alert("Changes saved successfully.");

  } catch(error){
    console.error("Save failed:", error);
    alert("Error saving changes. Please try again.");
    saveBtn.disabled = false;
    saveBtn.innerText = "Save";
  }
}
</script>
<div id="passwordModal" class="modal">
  <div class="modal-content">
    <h3>Enter Password</h3>
    <input type="password" id="adminPassword" placeholder="Password">
    <div style="margin-top:15px;text-align:right;">
      <button onclick="checkPassword()">Submit</button>
      <button onclick="closePasswordModal()">Cancel</button>
    </div>
  </div>
</div>

<div id="editModal" class="modal">
  <div class="modal-content">
    <h3 id="modalTitle"></h3>
    <textarea id="editTextarea"></textarea>
    <div style="margin-top:15px;text-align:right;">
      <button onclick="saveEdit()">Save</button>
      <button onclick="closeEditModal()">Cancel</button>
    </div>
  </div>
</div>

</body>
</html>
