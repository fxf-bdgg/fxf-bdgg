<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PAUD-FPAY Guide</title>
<style>
:root{
  --bg:#f4f7fb;
  --card:#ffffff;
  --muted:#64748b;
  --accent:#4d148c;
  --accent-2:#ff6600;
  font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  color:#0f172a;
}
*{box-sizing:border-box}
body{margin:0;background:linear-gradient(180deg,var(--bg),#eef6ff);display:flex;flex-direction:column;min-height:100vh;}
header, footer{background:var(--accent);color:white;padding:16px 28px;}
header h1, footer p{margin:0;font-weight:600;}
.container{max-width:1400px;margin:0 auto;display:grid;grid-template-columns:1fr 1fr 420px;gap:20px;align-items:start;padding:28px 0;flex:1}
.card{background:var(--card);border-radius:12px;padding:18px;box-shadow:0 8px 28px rgba(2,6,23,0.06);overflow:hidden}
h1{margin:0;font-size:22px;color:var(--accent)}
p.lead{margin:6px 0 14px;color:var(--muted);font-size:13px}
.progress-container{display:flex;align-items:center;gap:10px;margin:14px 0}
.progress-bar{flex:1;height:10px;background:#e2e8f0;border-radius:999px;overflow:hidden}
.progress-fill{height:100%;width:0%;background:var(--accent);transition:width .3s}
.progress-text{font-size:13px;color:var(--muted)}
.node{padding:12px;border-radius:10px;border:1px solid rgba(3,7,18,0.05);background:linear-gradient(180deg,#ffffff,#fbfeff);margin:10px 0;min-height:64px}
.choice-list{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
.choice{padding:8px 12px;border-radius:999px;background:#eef8f7;border:1px solid rgba(4,20,20,0.03);cursor:pointer;font-weight:600}
.choice:hover{background:#e0f2fe}
.choice.active{background:var(--accent);color:white}
.path{margin-top:12px;padding:10px;border-radius:10px;background:#f8fafc;border:1px dashed rgba(3,7,18,0.04);font-size:13px}
.path strong{color:var(--accent)}
.result{margin-top:12px;padding:12px;border-radius:10px;background:#e6fbfb;border-left:4px solid var(--accent-2);animation:fadeIn 0.4s ease-in;min-height:56px}
.note{margin-top:6px;font-size:13px;color:var(--muted);font-style:italic}
.controls{display:flex;gap:8px;margin-top:12px}
button{background:var(--accent);color:white;border:none;padding:9px 12px;border-radius:9px;cursor:pointer;font-weight:600}
button.secondary{background:#fff;color:var(--accent);border:1px solid #ccc}
.output-card{margin-top:16px;padding:14px;border-radius:10px;background:#ffffff;box-shadow:0 4px 12px rgba(0,0,0,0.05);animation:fadeIn 0.45s ease-in;position:relative}
.output-header{font-weight:700;color:#000;display:flex;justify-content:space-between;align-items:center;}
.output-box{padding:10px;border-left:4px solid var(--accent-2);background:#f8fafc;border-radius:8px;white-space:pre-wrap;font-size:11px}
.copy-btn{background:var(--accent);color:white;border:none;padding:6px 10px;margin-top:10px;border-radius:6px;cursor:pointer;font-size:13px}
.copy-btn:hover{opacity:.85}
.edit-icon{cursor:pointer;font-size:16px;color:var(--accent);margin-left:8px}
.edit-icon:hover{text-decoration:underline}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.45);align-items:center;justify-content:center;z-index:1000}
.modal-content{background:#fff;padding:25px;border-radius:12px;min-width:500px;max-width:600px;text-align:center;font-family:Inter,sans-serif;}
textarea{resize:none;width:100%;min-height:120px;padding:10px 12px;border-radius:8px;border:1px solid #d1d5db;font-size:14px;margin-top:10px;}
button.save-btn{background:var(--accent);color:#fff;}
button.cancel-btn{background:#e5e7eb;color:#111827;}
@keyframes fadeIn {from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
@media(max-width:1200px){.container{grid-template-columns:1fr}}
@media(max-width:500px){.modal-content{width:90%;min-width:unset;padding:20px}}
</style>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>

<body>

<header style="display:flex;align-items:center;justify-content:space-between;">
  <div style="display:flex;align-items:center;gap:12px;">
    <img src="fedex.png" style="height:40px;">
    <h1>PAUD-FPAY Guide</h1>
  </div>
  <button onclick="window.location.href='index.html'">Main Page</button>
</header>

<div class="container">
  <div class="card">
    <h1>PAUD-FPAY Guide</h1>
    <p class="lead">Follow the flow below to determine the TRUE debtor for FPAY.</p>

    <div class="progress-container">
      <div class="progress-bar"><div id="progressFill" class="progress-fill"></div></div>
      <div id="progressText" class="progress-text"></div>
    </div>

    <div id="flowArea" class="node"></div>

    <div class="controls">
      <button id="goBackBtn" class="secondary" style="display:none;">‚Üê Go Back</button>
      <button id="startOverBtn" class="secondary" style="display:none;">Start Over</button>
    </div>
  </div>

  <div class="card">
    <div class="node">
      <strong>Selected Path</strong>
      <div id="selectedPath" class="path">No steps selected yet.</div>
    </div>
    <div class="node">
      <strong>Recommended Action</strong>
      <div id="recommendation" class="result">No recommendation yet.</div>
    </div>
  </div>

  <div class="card" id="suggestedPanel" style="display:none;">
    <div class="output-card">
      <div class="output-header">
        Suggested Comment
        <span class="edit-icon" onclick="attemptEdit('comment')">‚úèÔ∏è</span>
      </div>
      <div id="suggestedComment" class="output-box"></div>
    </div>
    <div class="output-card">
      <div class="output-header">
        Possible CORR CODE
        <span class="edit-icon" onclick="attemptEdit('corr')">‚úèÔ∏è</span>
      </div>
      <div id="suggestedCorrCode" class="output-box"></div>
    </div>
    <div class="output-card">
      <div class="output-header">
        Suggested Email
        <span class="edit-icon" onclick="attemptEdit('email')">‚úèÔ∏è</span>
      </div>
      <div id="suggestedEmail" class="output-box"></div>
      <button class="copy-btn" id="copyEmailBtn">üìã Copy</button>
    </div>
  </div>
</div>

<footer>
  <p>¬© 2025 EBS Operations</p>
</footer>

<!-- Modals -->
<div id="passwordModal" class="modal">
  <div class="modal-content">
    <h3>Enter Password to Edit</h3>
    <input type="password" id="adminPassword" placeholder="Password">
    <div style="margin-top:18px;">
      <button class="save-btn" onclick="checkPassword()">Submit</button>
      <button class="cancel-btn" onclick="closePasswordModal()">Cancel</button>
    </div>
  </div>
</div>

<div id="editModal" class="modal">
  <div class="modal-content">
    <h3 id="modalTitle">Edit</h3>
    <div id="modalHint" class="note">Edits will be saved to Firestore (comments, emails, CORR codes).</div>
    <textarea id="editTextarea"></textarea>
    <div style="margin-top:18px;text-align:right;">
      <button class="save-btn" onclick="saveEdit()">Save</button>
      <button class="cancel-btn" onclick="closeEditModal()">Cancel</button>
    </div>
  </div>
</div>

<script>
/* ---------- FIREBASE INIT ---------- */
firebase.initializeApp({
  apiKey: "AIzaSyDjaMdeh0Cgx00hzDyZOi54fDkR81wnxJU",
  authDomain: "bdgg-database.firebaseapp.com",
  projectId: "bdgg-database"
});
const db = firebase.firestore();

/* ---------- STATE ---------- */
let path = [];
let historyStack = [];
let currentFinalRecommendation = "";
let currentEditType = "";

/* ---------- HELPERS ---------- */
function escapeHtml(text){ return text?text.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])):""; }
function docIdFromText(text){ return text.trim().toLowerCase().replace(/\s+/g,"_"); }
function getDocId(finalText,type){ return `${docIdFromText(finalText)}_${type}`; }

/* ---------- NODES ---------- */
const NODES = {

  /* ===== PART 1 : PRE-CHECKS ===== */

  root:{
    text:"Is there a BOL imaged on the PRO?",
    choices:[
      {label:"YES",next:"govt"},
      {label:"NO",next:"no_bol"}
    ]
  },

  no_bol:{
    text:"DO NOT RELEASE the PRO from FPAY. Leave in queue until BOL is on image. True debtor requires BOL review.",
    choices:[]
  },

  govt:{
    text:"Is the PRO a Government Shipment?",
    choices:[
      {label:"YES",next:"govt_move"},
      {label:"NO",next:"intl"}
    ]
  },

  govt_move:{
    text:"Move to PAUD GOVH ‚Äì GOVT ACCT. Review to update BT code with CUST % FPAY.",
    choices:[]
  },

  intl:{
    text:"Is this an International Shipment? (MX, AK, VI, PR)",
    choices:[
      {label:"YES",next:"intl_move"},
      {label:"NO",next:"tl"}
    ]
  },

  intl_move:{
    text:"Move PRO to its respective international queue.",
    choices:[]
  },

  tl:{
    text:"Does the PRO have Truckload keywords? (CAPL, CCD, TLX, TLS, CONT, EXCL)",
    choices:[
      {label:"YES",next:"no_autorate"},
      {label:"NO",next:"autorate"}
    ]
  },

  no_autorate:{
    text:"Proceed with correction but DO NOT AUTORATE.",
    choices:[
      {label:"CONTINUE", next:"review_bol"}
    ]
  },

  autorate:{
    text:"Proceed with review and AUTORATE if correction is required.",
    choices:[
      {label:"CONTINUE", next:"review_bol"}
    ]
  },

  /* ===== TRANSITION ===== */

  review_bol:{
    text:"Review the BOL to confirm the correct debtor.",
    choices:[
      {label:"CONTINUE", next:"fpay_correct_check"}
    ]
  },

  /* ===== PART 2 : FPAY TRUE DEBTOR ===== */

  fpay_correct_check:{
    text:"Is the PRO billing correctly to an FPAY?",
    choices:[
      {label:"YES", next:"billing_fpay_direct"},
      {label:"NO", next:"not_fpay_debtor"}
    ]
  },

  not_fpay_debtor:{
    text:"Correct debtor is not an FPAY and was not billed. Search for the account of the correct debtor per BOL and bill through the regular process.",
    choices:[]
  },

  billing_fpay_direct:{
    text:"Is the PRO billing the FPAY company directly?",
    choices:[
      {label:"YES", next:"direct_fpay_bol_check"},
      {label:"NO", next:"percent_fpay_check"}
    ]
  },

  /* ---- COMPANY % FPAY PATH ---- */

  percent_fpay_check:{
    text:"If PRO is billing Company % FPAY, is it the correct company in % FPAY per BOL?",
    choices:[
      {label:"YES", next:"proceed_post_bill"},
      {label:"NO", next:"account_search_process"}
    ]
  },

  /* ---- DIRECT FPAY PATH ---- */

  direct_fpay_bol_check:{
    text:"If PRO is billing FPAY company directly, is it the correct debtor per BOL?",
    choices:[
      {label:"YES", next:"bol_states_percent"},
      {label:"NO", next:"bol_states_only_fpay"}
    ]
  },

  bol_states_percent:{
    text:"BOL states Company % FPAY.",
    choices:[
      {label:"CONTINUE", next:"percent_fpay_check"}
    ]
  },

  bol_states_only_fpay:{
    text:"BOL states only the FPAY company.",
    choices:[
      {label:"CONTINUE", next:"account_search_process"}
    ]
  },

  /* ---- POST BILL ---- */

  proceed_post_bill:{
    text:
      "Proceed and post the bill.\n\n" +
      "Comment: VS-FPAY-AUDT + Specific Correction Comment " +
      "(VS-FPAY-AUDT + PRO IS BILLING THE CORRECT COMPANY % FPAY)\n" +
      "Correction Code: VRFY",
    choices:[]
  },

  /* ===== ACCOUNT SEARCH PROCESS (PER DIAGRAM) ===== */

  account_search_process:{
    text:"Is the FPAY related to the Shipper? (Same name, CAC, Google confirmed)",
    choices:[
      {label:"YES", next:"shipper_is_correct_debtor"},
      {label:"NO", next:"fpay_consignee_check"}
    ]
  },

  /* --- SHIPPER PATH --- */

  shipper_is_correct_debtor:{
    text:"Is the correct debtor (Shipper % FPAY) the ABT of the Shipper?",
    choices:[
      {label:"YES", next:"bill_shipper_prepaid"},
      {label:"NO", next:"different_shipper_abt_check"}
    ]
  },

  bill_shipper_prepaid:{
    text:"Proceed and bill the Shipper. Change terms to PREPAID to pull its ABT.",
    choices:[]
  },

  different_shipper_abt_check:{
    text:"Is there a different Shipper account that has Shipper % FPAY as its ABT?",
    choices:[
      {label:"YES", next:"update_shipper_code"},
      {label:"NO", next:"bill_company_fpay_as_3p"}
    ]
  },

  update_shipper_code:{
    text:"Use the account found and update the Shipper code to pull the correct BT account as ABT.",
    choices:[]
  },

  bill_company_fpay_as_3p:{
    text:"Bill the PRO PREPAID since Company % FPAY is related to the shipper. Then bill the Company % FPAY account directly as 3P.",
    choices:[]
  },

  /* --- CONSIGNEE PATH --- */

  fpay_consignee_check:{
    text:"Is the FPAY related to the Consignee? (Same name, CAC, Google confirmed)",
    choices:[
      {label:"YES", next:"consignee_is_correct_debtor"},
      {label:"NO", next:"shipment_history_check"}
    ]
  },

  consignee_is_correct_debtor:{
    text:"Is the correct debtor (Shipper % FPAY) the ABT of the Shipper?",
    choices:[
      {label:"YES", next:"bill_shipper_prepaid"},
      {label:"NO", next:"different_shipper_abt_check"}
    ]
  },

  /* --- HISTORY CHECK --- */

  shipment_history_check:{
    text:"Check shipment history of the Shipper and Consignee to see if there is a Company % FPAY that usually pays the invoices.",
    choices:[
      {label:"FOUND", next:"rebill_common_bt"},
      {label:"NOT FOUND", next:"check_direct_fpay_list"}
    ]
  },

  rebill_common_bt:{
    text:"A common BT account is available. Proceed with rebilling this account in an attempt of payment.",
    choices:[]
  },

  /* --- DIRECT FPAY LIST CHECK --- */

  check_direct_fpay_list:{
    text:"If no Company % FPAY was found, check if the PRO is listed under FPAY companies that can be billed directly.",
    choices:[
      {label:"FPAY ON LIST", next:"rebill_fpay_direct"},
      {label:"NOT ON LIST", next:"no_company_fpay_available"}
    ]
  },

  rebill_fpay_direct:{
    text:"FPAY is on the list. Proceed and rebill the FPAY company directly.",
    choices:[]
  },

  no_company_fpay_available:{
    text:"FPAY company is not on the list. DO NOT POST THE BILL. Comment on the PRO stating 'No Company % FPAY available'.",
    choices:[]
  }

};

/* ---------- RENDER NODE ---------- */
function renderNode(node, key="root") {
  const flowArea = document.getElementById("flowArea");
  const goBackBtn = document.getElementById("goBackBtn");
  const startOverBtn = document.getElementById("startOverBtn");
  const progressFill = document.getElementById("progressFill");
  const progressText = document.getElementById("progressText");
  const suggestedPanel = document.getElementById("suggestedPanel");
  
  flowArea.innerHTML = "";

  if (!node) return;

  if (!node.choices.length) {
    currentFinalRecommendation = node.text;
    document.getElementById("recommendation").innerHTML = `<strong>${escapeHtml(node.text)}</strong>`;
    generateSuggestedCommentEmail(node.text);
  } else {
    currentFinalRecommendation = "";
    document.getElementById("recommendation").innerText = "No recommendation yet.";
    suggestedPanel.style.display = "none";
  }

  const q = document.createElement("div");
  q.innerHTML = `<strong>${escapeHtml(node.text)}</strong>`;
  flowArea.appendChild(q);

  if (node.choices.length) {
    const list = document.createElement("div");
    list.className = "choice-list";

    node.choices.forEach(c => {
      const btn = document.createElement("div");
      btn.className = "choice"; // **no active class added**
      btn.textContent = c.label;

      btn.onclick = () => {
        historyStack.push({ key, path: [...path] });
        path.push({ question: node.text, answer: c.label });
        renderNode(NODES[c.next], c.next);
        updateSelectedPath();
      };

      list.appendChild(btn);
    });

    flowArea.appendChild(list);
  }

  goBackBtn.style.display = historyStack.length ? "inline-block" : "none";
  startOverBtn.style.display = path.length ? "inline-block" : "none";

  const stepNum = Math.max(1, path.length + (currentFinalRecommendation ? 1 : 0));
  progressFill.style.width = Math.min(stepNum * 18, 100) + "%";
  progressText.textContent = `Step ${Math.min(stepNum, 99)}`;
}


/* ---------- PATH ---------- */
function updateSelectedPath(){
  const el=document.getElementById("selectedPath");
  if(!path.length){ el.innerHTML="No steps selected yet."; return; }
  el.innerHTML=path.map((p,i)=>`<strong>Step ${i+1}:</strong> ${escapeHtml(p.question)} ‚Üí <strong><em>${escapeHtml(p.answer)}</em></strong>`).join("<br>");
}

/* ---------- FIRESTORE SUGGESTIONS ---------- */
async function generateSuggestedCommentEmail(finalText){
  const commentBox=document.getElementById("suggestedComment");
  const emailBox=document.getElementById("suggestedEmail");
  const corrBox=document.getElementById("suggestedCorrCode");
  const panel=document.getElementById("suggestedPanel");
  if(!finalText){ panel.style.display="none"; commentBox.innerText=emailBox.innerText=corrBox.innerText=""; return; }

  for(const type of ["comment","email","corr"]){
    const docRef=db.collection("fpay_templates").doc(getDocId(finalText,type));
    const snap=await docRef.get();
    if(!snap.exists){ await docRef.set({text:"",type}); if(type==="comment") commentBox.innerText=""; if(type==="email") emailBox.innerText=""; if(type==="corr") corrBox.innerText=""; }
    else { const val=snap.data().text||""; if(type==="comment") commentBox.innerText=val; else if(type==="email") emailBox.innerText=val; else if(type==="corr") corrBox.innerText=val; }
  }
  panel.style.display="block";
}

/* ---------- ADMIN EDIT ---------- */
function attemptEdit(type){ currentEditType=type; document.getElementById("adminPassword").value=""; document.getElementById("passwordModal").style.display="flex"; }
function closePasswordModal(){ document.getElementById("passwordModal").style.display="none"; }
function checkPassword(){ if(document.getElementById("adminPassword").value==="admin"){ closePasswordModal(); openEditModal(); } else alert("Incorrect password"); }
function openEditModal(){
  const boxes={comment:"suggestedComment",email:"suggestedEmail",corr:"suggestedCorrCode"};
  document.getElementById("editTextarea").value=document.getElementById(boxes[currentEditType]).innerText;
  document.getElementById("modalTitle").textContent=`Edit ${currentEditType.toUpperCase()}`;
  document.getElementById("editModal").style.display="flex";
}
function closeEditModal(){ document.getElementById("editModal").style.display="none"; }
async function saveEdit(){
  const val=document.getElementById("editTextarea").value.trim();
  if(!val){ alert("Cannot save empty text!"); return; }
  const ref=db.collection("fpay_templates").doc(getDocId(currentFinalRecommendation,currentEditType));
  await ref.set({text:val,type:currentEditType});
  document.getElementById(currentEditType==="comment"?"suggestedComment":currentEditType==="email"?"suggestedEmail":"suggestedCorrCode").innerText=val;
  closeEditModal(); alert("‚úÖ Saved to FPAY database");
}

/* ---------- EVENTS ---------- */
document.getElementById("goBackBtn").onclick=()=>{
  if(historyStack.length){
    const last=historyStack.pop();
    path=last.path||[];
    renderNode(NODES[last.key]||NODES.root,last.key||"root");
    updateSelectedPath();
  }
};
document.getElementById("startOverBtn").onclick=()=>{
  path=[]; historyStack=[]; currentFinalRecommendation="";
  document.getElementById("selectedPath").textContent="No steps selected yet";
  document.getElementById("suggestedPanel").style.display="none";
  renderNode(NODES.root,"root");
};
document.getElementById("copyEmailBtn").onclick=()=>{
  navigator.clipboard.writeText(document.getElementById("suggestedEmail").innerText||"")
    .then(()=>alert("Email copied!")).catch(()=>alert("Copy failed"));
};

/* ---------- INIT ---------- */
renderNode(NODES.root,"root");
</script>

</body>
</html>
