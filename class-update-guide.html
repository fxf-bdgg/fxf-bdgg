<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Class Update Guide</title>

<style>
/* ===== SAME STYLE AS REFERENCE ===== */
:root{
  --bg:#f4f7fb;
  --card:#ffffff;
  --muted:#64748b;
  --accent:#4d148c;
  --accent-2:#ff6600;
  font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  color:#0f172a;
}
*{box-sizing:border-box}
body{margin:0;background:linear-gradient(180deg,var(--bg),#eef6ff);display:flex;flex-direction:column;min-height:100vh;}
header, footer{background:var(--accent);color:white;padding:16px 28px;}
header h1, footer p{margin:0;font-weight:600;}
.container{max-width:1400px;margin:0 auto;display:grid;grid-template-columns:1fr 1fr 420px;gap:20px;align-items:start;padding:28px 0;flex:1}
.card{background:var(--card);border-radius:12px;padding:18px;box-shadow:0 8px 28px rgba(2,6,23,0.06);overflow:hidden;opacity:0;transform:translateY(20px)}
h1{margin:0;font-size:22px;color:var(--accent)}
p.lead{margin:6px 0 14px;color:var(--muted);font-size:13px}
.progress-container{display:flex;align-items:center;gap:10px;margin:14px 0}
.progress-bar{flex:1;height:10px;background:#e2e8f0;border-radius:999px;overflow:hidden}
.progress-fill{height:100%;width:0%;background:var(--accent);transition:width .3s}
.progress-text{font-size:13px;color:var(--muted)}
.node{padding:12px;border-radius:10px;border:1px solid rgba(3,7,18,0.05);background:linear-gradient(180deg,#ffffff,#fbfeff);margin:10px 0;min-height:64px}
.choice-list{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
.choice{padding:8px 12px;border-radius:999px;background:#eef8f7;border:1px solid rgba(4,20,20,0.03);cursor:pointer;font-weight:600}
.choice:hover{background:#e0f2fe}
.path{margin-top:12px;padding:10px;border-radius:10px;background:#f8fafc;border:1px dashed rgba(3,7,18,0.04);font-size:13px}
.path strong{color:var(--accent)}
.result{margin-top:12px;padding:12px;border-radius:10px;background:#e6fbfb;border-left:4px solid var(--accent-2);animation:fadeIn .4s ease-in;min-height:56px}
.note{margin-top:6px;font-size:13px;color:var(--muted);font-style:italic}
.controls{display:flex;gap:8px;margin-top:12px}
button{background:var(--accent);color:white;border:none;padding:9px 12px;border-radius:9px;cursor:pointer;font-weight:600}
button.secondary{background:#fff;color:var(--accent);border:1px solid #ccc}
.output-card{margin-top:16px;padding:14px;border-radius:10px;background:#fff;box-shadow:0 4px 12px rgba(0,0,0,.05);animation:fadeIn .45s ease-in;position:relative}
.output-header{font-weight:700;color:#000;display:flex;justify-content:space-between;align-items:center}
.output-box{padding:10px;border-left:4px solid var(--accent-2);background:#f8fafc;border-radius:8px;white-space:pre-wrap;font-size:11px}
.copy-btn{background:var(--accent);color:white;border:none;padding:6px 10px;margin-top:10px;border-radius:6px;cursor:pointer;font-size:13px}
.copy-btn:hover{opacity:.85}
.edit-icon{cursor:pointer;font-size:16px;color:var(--accent);margin-left:8px}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.45);align-items:center;justify-content:center;z-index:1000}
.modal-content{background:#fff;padding:25px;border-radius:12px;min-width:500px;max-width:600px;text-align:center}
textarea{resize:none;width:100%;min-height:120px;padding:10px 12px;border-radius:8px;border:1px solid #d1d5db;font-size:14px;margin-top:10px}
button.save-btn{background:var(--accent);color:#fff}
button.cancel-btn{background:#e5e7eb;color:#111827}

@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
@keyframes cardFadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:none}}
@keyframes logoFlyIn{from{opacity:0;transform:translateX(-50px) scale(.8)}to{opacity:1;transform:none}}

header img{opacity:0;animation:logoFlyIn 1s ease-out forwards}
header{position:relative;overflow:hidden}
header::after{content:"";position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(120deg,#4d148c,#ff6600,#4d148c);transform:skewX(-20deg);animation:sweep 1s ease-out forwards;opacity:.2}
@keyframes sweep{to{left:100%}}
@media(max-width:1200px){.container{grid-template-columns:1fr}}
.edit-icon{cursor:pointer;font-size:14px;margin-left:6px;color:var(--accent)}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.45);align-items:center;justify-content:center;z-index:1000}
.modal-content{background:#fff;padding:25px;border-radius:12px;min-width:500px;max-width:600px}
textarea{resize:none;width:100%;min-height:120px;padding:10px;border-radius:8px;border:1px solid #d1d5db;margin-top:10px}
</style>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>

<body>

<header style="display:flex;align-items:center;justify-content:space-between;">
  <div style="display:flex;align-items:center;gap:12px;">
    <a href="index.html">
      <img src="fedex.png" alt="FedEx Logo" style="height:40px;">
    </a>
    <h1>Class Update Guide</h1>
  </div>
  <button onclick="window.location.href='index.html'">Main Page</button>
</header>

<div class="container">
  <div class="card">
    <h1>Class Update Flow</h1>
    <p class="lead">Follow the steps below to determine the correct action for Class Update requests.</p>

    <div class="progress-container">
      <div class="progress-bar"><div id="progressFill" class="progress-fill"></div></div>
      <div id="progressText" class="progress-text">Not started</div>
    </div>

    <div id="flowArea" class="node"></div>

    <div class="controls">
      <button id="goBackBtn" class="secondary" style="display:none;">‚Üê Go Back</button>
      <button id="startOverBtn" class="secondary" style="display:none;">Start Over</button>
    </div>
  </div>

  <div class="card">
    <div class="node"><strong>Selected Path</strong><div id="selectedPath" class="path">No steps selected yet.</div></div>
    <div class="node"><strong>Recommended Action</strong><div id="recommendation" class="result">No recommendation yet.</div></div>
  </div>

   <div class="card" id="suggestedPanel" style="display:none;">
    <div class="output-card">
      <div class="output-header">Suggested Comment <span class="edit-icon" onclick="attemptEdit('comment')">‚úèÔ∏è</span></div>
      <div id="suggestedComment" class="output-box"></div>
    </div>
    <div class="output-card">
      <div class="output-header">Possible CORR CODE <span class="edit-icon" onclick="attemptEdit('corr')">‚úèÔ∏è</span></div>
      <div id="suggestedCorrCode" class="output-box"></div>
    </div>
    <div class="output-card">
      <div class="output-header">Suggested Email <span class="edit-icon" onclick="attemptEdit('email')">‚úèÔ∏è</span></div>
      <div id="suggestedEmail" class="output-box"></div>
      <button class="copy-btn" id="copyEmailBtn">üìã Copy</button>
    </div>
  </div>
</div>

<footer><p>¬© 2025 EBS Operations</p></footer>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyDjaMdeh0Cgx00hzDyZOi54fDkR81wnxJU",
  authDomain:"bdgg-database.firebaseapp.com",
  projectId:"bdgg-database"
});
const db=firebase.firestore();
const COLLECTION="class_update_templates"; // separate collection

let path=[],historyStack=[],currentFinalRecommendation="";

function escapeHtml(t){return t?t.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])):"";}
function docIdFromText(t){return t.trim().toLowerCase().replace(/\s+/g,"_");}
function getDocId(t,type){return `${docIdFromText(t)}_${type}`;}

// ===============================
// CLASS UPDATE GUIDE ‚Äì FULL FLOW
// ===============================

const NODES = {

  // ===============================
  // INTRO
  // ===============================

  class_update_intro: {
    text: "What is the Class update request?",
    choices: [
      { label: "CLASS UPDATE PER REWEIGHED WEIGHT", next: "class_update_reweigh" },
      { label: "CLASS UPDATE PER BOL", next: "bol_start" }
    ]
  },

  // =====================================================
  // ================= REWEIGH FLOW ======================
  // =====================================================
  
  class_update_reweigh: {
  text: "NOTE:\n\nSince REWE is not disputed, focus on the Class Update new PCF per reweighed request using the updated/current commodity weight shown on the body of the bill.",
  choices: [
    { label: "Continue", next: "reweigh_start" }
  ]
},

  reweigh_start: {
    text: "Is FACERT on file? CAPL, CCD or ADM present on the bill?",
    choices: [
      { label: "Yes", next: "reweigh_facert_yes" },
      { label: "No", next: "reweigh_check_cont_tls" }
    ]
  },

  reweigh_facert_yes: {
    text: "Move the case to Freight Research Inspection Review. Add CAPL at the beginning of the subject line.",
    choices: []
  },

  reweigh_check_cont_tls: {
    text: "CONT, TLS or TLX present on the body of the bill?",
    choices: [
      { label: "Yes", next: "reweigh_move_dispute" },
      { label: "No", next: "reweigh_valid_nmfc" }
    ]
  },

  reweigh_move_dispute: {
    text: "Move the case to Dispute Resolution Queue. Add VQ at the beginning of the subject line.",
    choices: []
  },

  reweigh_valid_nmfc: {
    text: "Is there a valid NMFC on the BOL?",
    choices: [
      { label: "Yes", next: "reweigh_density_check" },
      { label: "No", next: "reweigh_lookup_nmfc" }
    ]
  },

  reweigh_lookup_nmfc: {
    text: "Pull up NMFC lookup and try to search for the item description.",
    choices: [
      { label: "Located NMFC", next: "reweigh_density_check" },
      { label: "Not Located", next: "reweigh_support_docs" }
    ]
  },

  reweigh_support_docs: {
    text: "Ask for supporting documents.",
    choices: []
  },

  reweigh_density_check: {
    text: "Is the NMFC density based?",
    choices: [
      { label: "Yes", next: "reweigh_dimensions_check" },
      { label: "No", next: "reweigh_apply_nmfc_per_bol" }
    ]
  },

  reweigh_apply_nmfc_per_bol: {
    text: "No need to calculate the PCF. Apply the NMFC per BOL.",
    choices: []
  },

  reweigh_dimensions_check: {
    text: "Dimensions noted on BOL?",
    choices: [
      { label: "Yes", next: "reweigh_calculate_pcf" },
      { label: "No", next: "reweigh_cube_check" }
    ]
  },

  reweigh_cube_check: {
    text: "CUBE/CUBED noted on the body of the bill?",
    choices: [
      { label: "Yes", next: "reweigh_divide_weight" },
      { label: "No", next: "reweigh_request_dimensions" }
    ]
  },

  reweigh_request_dimensions: {
    text: "Ask for supporting documents showing the dimensions of the shipment.",
    choices: []
  },

  reweigh_divide_weight: {
    text: "Divide the total weight to the CUBE/CUBED on the body of the bill to get the new PCF.",
    choices: [
      { label: "Continue", next: "reweigh_lookup_after_calc" }
    ]
  },

  reweigh_calculate_pcf: {
    text: "Calculate the new PCF.",
    choices: [
      { label: "Continue", next: "reweigh_lookup_after_calc" }
    ]
  },

  reweigh_lookup_after_calc: {
    text: "Pull up the NMFC using NMFC lookup.",
    choices: [
      { label: "Continue", next: "reweigh_subclass_check" }
    ]
  },

  reweigh_subclass_check: {
    text: "Check on what subclass the new PCF will fall under.",
    choices: [
      { label: "Continue", next: "reweigh_apply_nmfc_invoice" }
    ]
  },

  reweigh_apply_nmfc_invoice: {
    text: "Apply the appropriate NMFC on the invoice per new PCF.",
    choices: []
  },

  // =====================================================
  // ===================== BOL FLOW ======================
  // =====================================================

  bol_start: {
    text: "Is FACERT available on image or inspection keywords on the body of the bill?",
    choices: [
      { label: "Yes", next: "bol_move_inspection" },
      { label: "No", next: "bol_both_class_nmfc" }
    ]
  },

  bol_move_inspection: {
    text: "Do not update the Pro. Move the case to Inspection Queue.",
    choices: []
  },

  bol_both_class_nmfc: {
    text: "Both Class/NMFC noted on BOL?",
    choices: [
      { label: "Yes", next: "bol_nmfc_valid_check" },
      { label: "No", next: "bol_lookup_nmfc" }
    ]
  },

  bol_nmfc_valid_check: {
    text: "NMFC valid?",
    choices: [
      { label: "Yes", next: "bol_apply_nmfc_supersedes" },
      { label: "No", next: "bol_apply_class_per_bol" }
    ]
  },

  bol_apply_class_per_bol: {
    text: "Apply class per BOL (NMFC supersedes Class).",
    choices: []
  },

  bol_apply_nmfc_supersedes: {
    text: "Apply the NMFC on the Pro (NMFC supersedes Class).",
    choices: []
  },

  bol_lookup_nmfc: {
    text: "Pull up NMFC lookup and try to search for the item description.",
    choices: [
      { label: "Located NMFC", next: "bol_density_check" },
      { label: "Not Located", next: "bol_support_docs" }
    ]
  },

  bol_support_docs: {
    text: "Ask for supporting documents.",
    choices: []
  },

  bol_density_check: {
    text: "Is the NMFC density based?",
    choices: [
      { label: "Yes", next: "bol_dimensions_check" },
      { label: "No", next: "bol_apply_nmfc_per_bol" }
    ]
  },

  bol_apply_nmfc_per_bol: {
    text: "No need to calculate the PCF. Apply the NMFC per BOL.",
    choices: []
  },

  bol_dimensions_check: {
    text: "Dimensions noted on BOL?",
    choices: [
      { label: "Yes", next: "bol_calculate_pcf" },
      { label: "No", next: "bol_cube_check" }
    ]
  },

  bol_cube_check: {
    text: "CUBE/CUBED noted on the body of the bill?",
    choices: [
      { label: "Yes", next: "bol_divide_weight" },
      { label: "No", next: "bol_request_dimensions" }
    ]
  },

  bol_request_dimensions: {
    text: "Ask for supporting documents showing the dimensions of the shipment.",
    choices: []
  },

  bol_divide_weight: {
    text: "Divide the total weight to the CUBE/CUBED on the body of the bill to get the new PCF.",
    choices: [
      { label: "Continue", next: "bol_lookup_after_calc" }
    ]
  },

  bol_calculate_pcf: {
    text: "Calculate the new PCF.",
    choices: [
      { label: "Continue", next: "bol_lookup_after_calc" }
    ]
  },

  bol_lookup_after_calc: {
    text: "Pull up the NMFC using NMFC lookup.",
    choices: [
      { label: "Continue", next: "bol_subclass_check" }
    ]
  },

  bol_subclass_check: {
    text: "Check on what subclass the PCF will fall under.",
    choices: [
      { label: "Continue", next: "bol_apply_nmfc_invoice" }
    ]
  },

  bol_apply_nmfc_invoice: {
    text: "Apply the appropriate NMFC on the invoice.",
    choices: []
  }

};

// --------- Functions ----------
function renderNode(node,key="class_update_intro"){
  const flowArea=document.getElementById("flowArea");
  const panel=document.getElementById("suggestedPanel");
  const progressFill=document.getElementById("progressFill");
  const progressText=document.getElementById("progressText");

  flowArea.innerHTML="";
  if(!node) return;

  if(!node.choices.length){
    currentFinalRecommendation=node.text;
    recommendation.innerHTML=`<strong>${escapeHtml(node.text)}</strong>`;
    generateSuggested(node.text);
  } else {
    currentFinalRecommendation="";
    recommendation.innerText="No recommendation yet.";
    panel.style.display="none";
  }

  const q=document.createElement("div");
  q.innerHTML=`<strong>${escapeHtml(node.text)}</strong>`;
  flowArea.appendChild(q);

  if(node.choices.length){
    const list=document.createElement("div");
    list.className="choice-list";
    node.choices.forEach(c=>{
      const btn=document.createElement("div");
      btn.className="choice";
      btn.textContent=c.label;
      btn.onclick=()=>{
        historyStack.push({key,path:[...path]});
        path.push({question:node.text,answer:c.label});
        renderNode(NODES[c.next],c.next);
        updateSelectedPath();
      };
      list.appendChild(btn);
    });
    flowArea.appendChild(list);
  }

  if(key==="class_update_intro"){
    progressFill.style.width="0%";
    progressText.textContent="Not started";
  } else {
    const s=Math.max(1,path.length);
    progressFill.style.width=Math.min(s*20,100)+"%";
    progressText.textContent=`Step ${s}`;
  }

  goBackBtn.style.display=historyStack.length && key!=="class_update_intro"?"inline-block":"none";
  startOverBtn.style.display=key!=="class_update_intro"?"inline-block":"none";
}

function updateSelectedPath(){
  selectedPath.innerHTML=path.length?
    path.map((p,i)=>`<strong>Step ${i+1}:</strong> ${escapeHtml(p.question)} ‚Üí <strong><em>${escapeHtml(p.answer)}</em></strong>`).join("<br>")
    :"No steps selected yet.";
}

async function generateSuggested(finalText){
  const panel=document.getElementById("suggestedPanel");
  for(const type of ["comment","email","corr"]){
    const ref=db.collection(COLLECTION).doc(getDocId(finalText,type));
    const snap=await ref.get();
    if(!snap.exists) await ref.set({text:"",type});
    const val=snap.exists?(snap.data().text||""):"";
    if(type==="comment") suggestedComment.innerText=val;
    if(type==="email") suggestedEmail.innerText=val;
    if(type==="corr") suggestedCorrCode.innerText=val;
  }
  panel.style.display="block";
}

goBackBtn.onclick=()=>{if(historyStack.length){const last=historyStack.pop();path=last.path||[];renderNode(NODES[last.key],last.key);updateSelectedPath();}};
startOverBtn.onclick=()=>{path=[];historyStack=[];currentFinalRecommendation="";selectedPath.textContent="No steps selected yet";suggestedPanel.style.display="none";renderNode(NODES.class_update_intro,"class_update_intro");};

renderNode(NODES.class_update_intro,"class_update_intro");

window.addEventListener('load',()=>{
  document.querySelectorAll('.card').forEach((c,i)=>{
    c.style.animation=`cardFadeIn .6s ease-out forwards`;
    c.style.animationDelay=`${1+i*.15}s`;
  });
});

let currentEditType="";

function attemptEdit(type){
  currentEditType=type;
  document.getElementById("passwordModal").style.display="flex";
}

function closePasswordModal(){
  document.getElementById("passwordModal").style.display="none";
}

function checkPassword(){
  if(document.getElementById("adminPassword").value==="admin"){
    closePasswordModal();
    openEditModal();
  }else{
    alert("Incorrect password");
  }
}

function openEditModal(){
  const map={
    comment:"suggestedComment",
    email:"suggestedEmail",
    corr:"suggestedCorrCode"
  };

  document.getElementById("editTextarea").value=
    document.getElementById(map[currentEditType]).innerText;

  document.getElementById("modalTitle").innerText=
    "Edit "+currentEditType.toUpperCase();

  document.getElementById("editModal").style.display="flex";
}

function closeEditModal(){
  document.getElementById("editModal").style.display="none";
}

async function saveEdit(){
  const textarea = document.getElementById("editTextarea");
  const saveBtn = document.querySelector("#editModal button");
  const val = textarea.value.trim();

  if(!val){
    alert("Cannot save empty text");
    return;
  }

  try{
    // Show saving state
    saveBtn.disabled = true;
    const originalText = saveBtn.innerText;
    saveBtn.innerText = "Saving...";

    const ref = db.collection(COLLECTION)
      .doc(getDocId(currentFinalRecommendation,currentEditType));

    await ref.set({text:val,type:currentEditType});

    // Update UI immediately
    document.getElementById(
      currentEditType==="comment"?"suggestedComment":
      currentEditType==="email"?"suggestedEmail":"suggestedCorrCode"
    ).innerText = val;

    // Restore button
    saveBtn.innerText = originalText;
    saveBtn.disabled = false;

    closeEditModal();
    alert("Changes saved successfully.");

  } catch(error){
    console.error("Save failed:", error);
    alert("Error saving changes. Please try again.");
    saveBtn.disabled = false;
    saveBtn.innerText = "Save";
  }
}

</script>
<div id="passwordModal" class="modal">
  <div class="modal-content">
    <h3>Enter Password</h3>
    <input type="password" id="adminPassword" placeholder="Password">
    <div style="margin-top:15px;text-align:right;">
      <button onclick="checkPassword()">Submit</button>
      <button onclick="closePasswordModal()">Cancel</button>
    </div>
  </div>
</div>

<div id="editModal" class="modal">
  <div class="modal-content">
    <h3 id="modalTitle"></h3>
    <textarea id="editTextarea"></textarea>
    <div style="margin-top:15px;text-align:right;">
      <button onclick="saveEdit()">Save</button>
      <button onclick="closeEditModal()">Cancel</button>
    </div>
  </div>
</div>
</body>
</html>
