<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Correction Code Guide</title>
<style>
:root{
  --bg:#f4f7fb;
  --card:#ffffff;
  --muted:#64748b;
  --accent:#4d148c;
  --accent-2:#ff6600;
  font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  color:#0f172a;
}
*{box-sizing:border-box}
body{margin:0;background:linear-gradient(180deg,var(--bg),#eef6ff);display:flex;flex-direction:column;min-height:100vh;}
header, footer{background:var(--accent);color:white;padding:16px 28px;}
header h1, footer p{margin:0;font-weight:600;}
.container{max-width:1400px;margin:0 auto;display:grid;grid-template-columns:1fr 1fr 420px;gap:20px;align-items:start;padding:28px 0;flex:1}
.card{background:var(--card);border-radius:12px;padding:18px;box-shadow:0 8px 28px rgba(2,6,23,0.06);overflow:hidden}
h1{margin:0;font-size:22px;color:var(--accent)}
p.lead{margin:6px 0 14px;color:var(--muted);font-size:13px}
.progress-container{display:flex;align-items:center;gap:10px;margin:14px 0}
.progress-bar{flex:1;height:10px;background:#e2e8f0;border-radius:999px;overflow:hidden}
.progress-fill{height:100%;width:0%;background:var(--accent);transition:width .3s}
.progress-text{font-size:13px;color:var(--muted)}
.node{padding:12px;border-radius:10px;border:1px solid rgba(3,7,18,0.05);background:linear-gradient(180deg,#ffffff,#fbfeff);margin:10px 0;min-height:64px}
.choice-list{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
.choice{padding:8px 12px;border-radius:999px;background:#eef8f7;border:1px solid rgba(4,20,20,0.03);cursor:pointer;font-weight:600}
.choice:hover{background:#e0f2fe}
.path{margin-top:12px;padding:10px;border-radius:10px;background:#f8fafc;border:1px dashed rgba(3,7,18,0.04);font-size:13px}
.path strong{color:var(--accent)}
.result{margin-top:12px;padding:12px;border-radius:10px;background:#e6fbfb;border-left:4px solid var(--accent-2);animation:fadeIn 0.4s ease-in;min-height:56px}
.note{margin-top:6px;font-size:13px;color:var(--muted);font-style:italic}
.controls{display:flex;gap:8px;margin-top:12px}
button{background:var(--accent);color:white;border:none;padding:9px 12px;border-radius:9px;cursor:pointer;font-weight:600}
button.secondary{background:#fff;color:var(--accent);border:1px solid #ccc}
.output-card{margin-top:16px;padding:14px;border-radius:10px;background:#ffffff;box-shadow:0 4px 12px rgba(0,0,0,0.05);animation:fadeIn 0.45s ease-in;position:relative}
.output-header{font-weight:700;color:#000;display:flex;justify-content:space-between;align-items:center;}
.output-box{padding:10px;border-left:4px solid var(--accent-2);background:#f8fafc;border-radius:8px;white-space:pre-wrap;font-size:11px}
.copy-btn{background:var(--accent);color:white;border:none;padding:6px 10px;margin-top:10px;border-radius:6px;cursor:pointer;font-size:13px}
.edit-icon{cursor:pointer;font-size:16px;color:var(--accent);margin-left:8px}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.45);align-items:center;justify-content:center;z-index:1000}
.modal-content{background:#fff;padding:25px;border-radius:12px;min-width:500px;max-width:600px;text-align:center;font-family:Inter,sans-serif;}
textarea{resize:none;width:100%;min-height:120px;padding:10px 12px;border-radius:8px;border:1px solid #d1d5db;font-size:14px;margin-top:10px;}
button.save-btn{background:var(--accent);color:#fff;}
button.cancel-btn{background:#e5e7eb;color:#111827;}
@keyframes fadeIn {from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
@media(max-width:1200px){.container{grid-template-columns:1fr}}
@media(max-width:500px){.modal-content{width:90%;min-width:unset;padding:20px}}
</style>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body>

<header style="display:flex;align-items:center;justify-content:space-between;">
  <h1>Correction Code Guide</h1>
  <button onclick="window.location.href='index.html'">Main Page</button>
</header>

<div class="container">
  <div class="card">
    <h1>Correction Code Guide</h1>
    <p class="lead">Follow the flow below to determine the correct CORR CODE.</p>

    <div class="progress-container">
      <div class="progress-bar"><div id="progressFill" class="progress-fill"></div></div>
      <div id="progressText" class="progress-text">Not started</div>
    </div>

    <div id="flowArea" class="node"></div>

    <div class="controls">
      <button id="goBackBtn" class="secondary" style="display:none;">‚Üê Go Back</button>
      <button id="startOverBtn" class="secondary" style="display:none;">Start Over</button>
    </div>
  </div>

  <div class="card">
    <div class="node">
      <strong>Selected Path</strong>
      <div id="selectedPath" class="path">No steps selected yet.</div>
    </div>
    <div class="node">
      <strong>Recommended Action</strong>
      <div id="recommendation" class="result">No recommendation yet.</div>
    </div>
  </div>

  <div class="card" id="suggestedPanel" style="display:none;">
    <div class="output-card">
      <div class="output-header">Suggested Comment <span class="edit-icon" onclick="attemptEdit('comment')">‚úèÔ∏è</span></div>
      <div id="suggestedComment" class="output-box"></div>
    </div>
    <div class="output-card">
      <div class="output-header">Possible CORR CODE <span class="edit-icon" onclick="attemptEdit('corr')">‚úèÔ∏è</span></div>
      <div id="suggestedCorrCode" class="output-box"></div>
    </div>
    <div class="output-card">
      <div class="output-header">Suggested Email <span class="edit-icon" onclick="attemptEdit('email')">‚úèÔ∏è</span></div>
      <div id="suggestedEmail" class="output-box"></div>
      <button class="copy-btn" id="copyEmailBtn">üìã Copy</button>
    </div>
  </div>
</div>

<footer><p>¬© 2025 EBS Operations</p></footer>

<!-- Modals -->
<div id="passwordModal" class="modal">
  <div class="modal-content">
    <h3>Enter Password to Edit</h3>
    <input type="password" id="adminPassword" placeholder="Password">
    <div style="margin-top:18px;">
      <button class="save-btn" onclick="checkPassword()">Submit</button>
      <button class="cancel-btn" onclick="closePasswordModal()">Cancel</button>
    </div>
  </div>
</div>

<div id="editModal" class="modal">
  <div class="modal-content">
    <h3 id="modalTitle">Edit</h3>
    <div class="note">Edits will be saved to Firestore.</div>
    <textarea id="editTextarea"></textarea>
    <div style="margin-top:18px;text-align:right;">
      <button class="save-btn" onclick="saveEdit()">Save</button>
      <button class="cancel-btn" onclick="closeEditModal()">Cancel</button>
    </div>
  </div>
</div>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyDjaMdeh0Cgx00hzDyZOi54fDkR81wnxJU",
  authDomain: "bdgg-database.firebaseapp.com",
  projectId: "bdgg-database"
});
const db = firebase.firestore();

let path=[], historyStack=[], currentFinalRecommendation="", currentEditType="";

function escapeHtml(t){return t?t.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])):"";}
function docIdFromText(t){return t.trim().toLowerCase().replace(/\s+/g,"_");}
function getDocId(t,type){return `${docIdFromText(t)}_${type}`;}

const NODES = {

cc_intro:{
  text:"What is the correction that you are trying to do?",
  choices:[
    {label:"Change Terms per BOL",next:"cc_change_terms"},
    {label:"Change Account Code",next:"cc_change_account"},
    {label:"Change of Class/NMFC/Description/Handling Unit per BOL",next:"cc_class_change"},
    {label:"Change of Weight per BOL",next:"cc_weight_change"},
    {label:"Change Service Type",next:"cc_service_type"},
    {label:"Reference no Edit",next:"cc_reference_edit"},
    {label:"Accessorial Update",next:"cc_accessorial"},
    {label:"Pricing Related Update",next:"cc_pricing"}
  ]
},

cc_tbd:{ text:"This branch is not built yet. We‚Äôll continue this later.", choices:[] },

/* ===================== CHANGE TERMS ===================== */

cc_change_terms:{ 
  text:"Why are you changing the terms?", 
  choices:[
    {label:"Terms was entered incorrectly",next:"cc_terms_incorrect_who"},
    {label:"Rebill in attempt of payment",next:"cc_terms_rebill_attempt"}
  ]
},

cc_terms_rebill_attempt:{ 
  text:"CORR ACCR ‚Äì Any update made on Terms or Account in attempt of payment when PRO is billing correctly per BOL.\n\nPro is billing correctly but Consignee refused to pay. If unpaid for more than 6 months, try rebilling to Shipper.", 
  choices:[]
},

cc_terms_incorrect_who:{ 
  text:"Who entered the incorrect terms?", 
  choices:[
    {label:"Biller",next:"cc_terms_bol_confusing_biller"},
    {label:"Revenue Services / Revenue Quality Agent",next:"cc_terms_bol_confusing_biller"},
    {label:"Customer via ISPI",next:"cc_terms_bol_confusing_biller"},
    {label:"System",next:"cc_terms_bol_confusing_system"}
  ]
},

cc_terms_bol_confusing_biller:{ 
  text:"Is the BOL confusing or does it provide conflicting information that can cause confusion?", 
  choices:[
    {label:"YES",next:"cc_terms_cusi"},
    {label:"NO",next:"cc_terms_etms"}
  ]
},

cc_terms_bol_confusing_system:{ 
  text:"Is the BOL confusing or does it provide conflicting information that can cause confusion to the agent?", 
  choices:[
    {label:"YES",next:"cc_terms_agent_billed_back"},
    {label:"NO",next:"cc_terms_rqe"}
  ]
},

cc_terms_agent_billed_back:{ 
  text:"Did the agent bill it back to the shipper due to conflicting information?", 
  choices:[
    {label:"YES",next:"cc_terms_cusi"},
    {label:"NO",next:"cc_terms_cae"}
  ]
},

cc_terms_cusi:{ text:"CORR CUSI ‚Äì Incorrect terms due to confusing or inaccurate BOL.", choices:[] },
cc_terms_etms:{ text:"CORR ETMS ‚Äì Biller entered incorrect terms even if BOL is accurate.", choices:[] },
cc_terms_cae:{ text:"CORR CAE ‚Äì RSA entered incorrect terms even if BOL is accurate.", choices:[] },
cc_terms_rqe:{ text:"CORR RQE ‚Äì RQA entered incorrect terms even if BOL is accurate.", choices:[] },

/* ===================== CHANGE ACCOUNT CODE ===================== */

cc_change_account:{
  text:"Why are you changing an Account code?",
  choices:[
    {label:"BOL shows an account no. or Bill To information but was not entered by the biller",next:"cc_acct_bol_not_entered"},
    {label:"Customer is requesting to use a different account no. for billing",next:"cc_acct_customer_request"},
    {label:"Rebill in attempt of payment",next:"cc_acct_rebill_attempt"}
  ]
},

cc_acct_rebill_attempt:{ 
  text:"CORR ACCR ‚Äì Any update made on Terms or Account in attempt of payment when PRO is billing correctly per BOL.", 
  choices:[]
},

cc_acct_bol_not_entered:{
  text:"Is the BOL confusing or provide conflicting/incomplete information that can cause confusion to the biller?",
  choices:[
    {label:"YES",next:"cc_acct_cusi"},
    {label:"NO",next:"cc_acct_ecd"}
  ]
},

cc_acct_cusi:{ text:"CORR CUSI ‚Äì Used when changing Account Code but should not be taken against the biller since BOL has conflicting information.", choices:[] },
cc_acct_ecd:{ text:"CORR ECD ‚Äì Used when changing Account Code since biller entered an incorrect code not on the BOL or different from what the BOL states.", choices:[] },

cc_acct_customer_request:{
  text:"Is the account noted on the BOL and clearly states that account no. should be billed? (not confusing or inaccurate)",
  choices:[
    {label:"YES",next:"cc_acct_ecd_customer"},
    {label:"NO",next:"cc_acct_accr_customer"}
  ]
},

cc_acct_ecd_customer:{ text:"CORR ECD ‚Äì Used when changing Account Code since biller entered an incorrect code not on the BOL or different from what the BOL states.", choices:[] },
cc_acct_accr_customer:{ text:"CORR ACCR ‚Äì Used when changing Account Code per customer request or proper billing (found through Customer Search).", choices:[] },

/* ===================== CHANGE CLASS / WEIGHT ===================== */

cc_class_change:{
  text:"Who entered the incorrect Class?",
  choices:[
    {label:"Biller ‚Äì Initial entry of information",next:"cc_class_biller_confusing"},
    {label:"Revenue Services Agent / Revenue Quality Agent",next:"cc_class_rsa_confusing"}
  ]
},

cc_weight_change:{
  text:"Who entered the incorrect Weight?",
  choices:[
    {label:"Biller ‚Äì Initial entry of information",next:"cc_class_biller_confusing"},
    {label:"Revenue Services Agent / Revenue Quality Agent",next:"cc_class_rsa_confusing"}
  ]
},

cc_class_biller_confusing:{
  text:"Is the BOL confusing or provide conflicting/incomplete information that can cause confusion?",
  choices:[
    {label:"YES",next:"cc_class_cusi"},
    {label:"NO",next:"cc_class_ewpd"}
  ]
},

cc_class_rsa_confusing:{
  text:"Is the BOL confusing or provide conflicting/incomplete information that can cause confusion?",
  choices:[
    {label:"YES",next:"cc_class_cusi"},
    {label:"NO",next:"cc_class_cae_rqe"}
  ]
},

cc_class_cusi:{ text:"CORR CUSI ‚Äì Incorrect class/weight due to confusing or inaccurate BOL.", choices:[] },
cc_class_ewpd:{ text:"CORR EWPD ‚Äì Incorrect class/weight entered by biller even though BOL is accurate.", choices:[] },
cc_class_cae_rqe:{ text:"CORR CAE ‚Äì If error was done by Revenue Services Agent.\nCORR RQE ‚Äì If error was done by Revenue Quality Agent.", choices:[] },

/* ===================== CHANGE SERVICE TYPE ===================== */

cc_service_type:{ text:"CORR EPDC ‚Äì Service Type correction.", choices:[] },

/* ===================== REFERENCE NO EDIT ===================== */

cc_reference_edit:{
  text:"Is the Reference No. that you are updating noted on BOL?",
  choices:[
    {label:"YES",next:"cc_reference_eref"},
    {label:"NO",next:"cc_reference_cusi"}
  ]
},

cc_reference_eref:{ text:"CORR EREF ‚Äì Reference number noted on BOL but not entered.", choices:[] },
cc_reference_cusi:{ text:"CORR CUSI ‚Äì Reference number not supported by BOL.", choices:[] },

/* ===================== ACCESSORIAL UPDATE ===================== */

cc_accessorial:{
  text:"What update are you trying to make?",
  choices:[
    {label:"Adding Accessorial not requested on BOL",next:"cc_acc_acc"},
    {label:"Changing Accessorial from one type to another",next:"cc_acc_eadl"},
    {label:"Removing Accessorial since not performed",next:"cc_acc_nacc"},
    {label:"Adding/Removing per BOL request or changing debtor",next:"cc_acc_eacc"},
    {label:"Removing due to Service Center Error",next:"cc_acc_ops"},
    {label:"Removing due to Revenue Services / Revenue Quality Error",next:"cc_acc_rev_error"}
  ]
},

cc_acc_acc:{ text:"CORR ACC ‚Äì Adding accessorial not requested on BOL.", choices:[] },
cc_acc_eadl:{ text:"CORR EADL ‚Äì Changing accessorial from one type to another.", choices:[] },
cc_acc_nacc:{ text:"CORR NACC ‚Äì Removing accessorial since not performed.", choices:[] },
cc_acc_eacc:{ text:"CORR EACC ‚Äì Adding or removing accessorial per request/instruction on BOL or changing debtor.", choices:[] },

cc_acc_ops:{
  text:"Was the error made by Origin or Destination?",
  choices:[
    {label:"Origin Center",next:"cc_acc_opso"},
    {label:"Destination Center",next:"cc_acc_opsd"}
  ]
},

cc_acc_opso:{ text:"CORR OPSO ‚Äì Error made by Origin Center.", choices:[] },
cc_acc_opsd:{ text:"CORR OPSD ‚Äì Error made by Destination Center.", choices:[] },

cc_acc_rev_error:{
  text:"Who made the error?",
  choices:[
    {label:"Revenue Services Agent",next:"cc_acc_cae"},
    {label:"Revenue Quality Agent",next:"cc_acc_rqe"}
  ]
},

cc_acc_cae:{ text:"CORR CAE ‚Äì Error done by Revenue Services Agent.", choices:[] },
cc_acc_rqe:{ text:"CORR RQE ‚Äì Error done by Revenue Quality Agent.", choices:[] },

/* ===================== PRICING RELATED UPDATE ===================== */

cc_pricing:{
  text:"What correction are you trying to make?",
  choices:[
    {label:"Autorating or Manual Agreement Exception",next:"cc_pricing_sysm"},
    {label:"Expired Freight Pricing or Surcharge Exception",next:"cc_pricing_expr"},
    {label:"Rating correction error by Revenue Services",next:"cc_pricing_prce"},
    {label:"General protection of invoice",next:"cc_pricing_prot"},
    {label:"PRO protected per CHT Hierarchy Update",next:"cc_pricing_prha"},
    {label:"Brand new pricing within 10 days from Ship Date",next:"cc_pricing_ssdy"}
  ]
},

cc_pricing_sysm:{ text:"CORR SYSM ‚Äì Autorating the PRO or applying agreement exception.", choices:[] },
cc_pricing_expr:{ text:"CORR EXPR ‚Äì Expired freight pricing or surcharge exception.", choices:[] },
cc_pricing_prce:{ text:"CORR PRCE ‚Äì Rating correction error by Revenue Services employee.", choices:[] },
cc_pricing_prot:{ text:"CORR PROT ‚Äì General protection of invoice.", choices:[] },
cc_pricing_prha:{ text:"CORR PRHA ‚Äì PRO protected per CHT hierarchy update.", choices:[] },
cc_pricing_ssdy:{ text:"CORR SSDY ‚Äì Brand new pricing and PRO rerated within 10 days from Ship Date.", choices:[] }

};


function renderNode(node,key="cc_intro"){
  const flowArea=document.getElementById("flowArea");
  const goBackBtn=document.getElementById("goBackBtn");
  const startOverBtn=document.getElementById("startOverBtn");
  const progressFill=document.getElementById("progressFill");
  const progressText=document.getElementById("progressText");
  const panel=document.getElementById("suggestedPanel");

  flowArea.innerHTML="";
  if(!node) return;

  if(!node.choices.length){
    currentFinalRecommendation=node.text;
    document.getElementById("recommendation").innerHTML=`<strong>${escapeHtml(node.text)}</strong>`;
    generateSuggestedCommentEmail(node.text);
  } else {
    currentFinalRecommendation="";
    document.getElementById("recommendation").innerText="No recommendation yet.";
    panel.style.display="none";
  }

  const q=document.createElement("div");
  q.innerHTML=`<strong>${escapeHtml(node.text)}</strong>`;
  flowArea.appendChild(q);

  if(node.choices.length){
    const list=document.createElement("div");
    list.className="choice-list";
    node.choices.forEach(c=>{
      const btn=document.createElement("div");
      btn.className="choice";
      btn.textContent=c.label;
      btn.onclick=()=>{
        historyStack.push({key,path:[...path]});
        path.push({question:node.text,answer:c.label});
        renderNode(NODES[c.next],c.next);
        updateSelectedPath();
      };
      list.appendChild(btn);
    });
    flowArea.appendChild(list);
  }

  if(key==="cc_intro"){
    progressFill.style.width="0%";
    progressText.textContent="Not started";
  } else {
    const stepNum=Math.max(1,path.length);
    progressFill.style.width=Math.min(stepNum*18,100)+"%";
    progressText.textContent=`Step ${stepNum}`;
  }

  goBackBtn.style.display=historyStack.length && key!=="cc_intro"?"inline-block":"none";
  startOverBtn.style.display=key!=="cc_intro"?"inline-block":"none";
}

function updateSelectedPath(){
  const el=document.getElementById("selectedPath");
  if(!path.length){ el.innerHTML="No steps selected yet."; return; }
  el.innerHTML=path.map((p,i)=>`<strong>Step ${i+1}:</strong> ${escapeHtml(p.question)} ‚Üí <strong><em>${escapeHtml(p.answer)}</em></strong>`).join("<br>");
}

async function generateSuggestedCommentEmail(finalText){
  const commentBox=document.getElementById("suggestedComment");
  const emailBox=document.getElementById("suggestedEmail");
  const corrBox=document.getElementById("suggestedCorrCode");
  const panel=document.getElementById("suggestedPanel");
  for(const type of ["comment","email","corr"]){
    const ref=db.collection("corrcode_templates").doc(getDocId(finalText,type));
    const snap=await ref.get();
    if(!snap.exists){ await ref.set({text:"",type}); }
    const val=snap.exists?(snap.data().text||""):"";
    if(type==="comment") commentBox.innerText=val;
    if(type==="email") emailBox.innerText=val;
    if(type==="corr") corrBox.innerText=val;
  }
  panel.style.display="block";
}

function attemptEdit(type){ currentEditType=type; document.getElementById("passwordModal").style.display="flex"; }
function closePasswordModal(){ document.getElementById("passwordModal").style.display="none"; }
function checkPassword(){ if(document.getElementById("adminPassword").value==="admin"){ closePasswordModal(); openEditModal(); } else alert("Incorrect password"); }
function openEditModal(){
  const map={comment:"suggestedComment",email:"suggestedEmail",corr:"suggestedCorrCode"};
  document.getElementById("editTextarea").value=document.getElementById(map[currentEditType]).innerText;
  document.getElementById("modalTitle").textContent=`Edit ${currentEditType.toUpperCase()}`;
  document.getElementById("editModal").style.display="flex";
}
function closeEditModal(){ document.getElementById("editModal").style.display="none"; }
async function saveEdit(){
  const val=document.getElementById("editTextarea").value.trim();
  if(!val) return alert("Cannot save empty text!");
  const ref=db.collection("corrcode_templates").doc(getDocId(currentFinalRecommendation,currentEditType));
  await ref.set({text:val,type:currentEditType});
  document.getElementById(currentEditType==="comment"?"suggestedComment":currentEditType==="email"?"suggestedEmail":"suggestedCorrCode").innerText=val;
  closeEditModal(); alert("Saved!");
}

document.getElementById("goBackBtn").onclick=()=>{
  if(historyStack.length){
    const last=historyStack.pop();
    path=last.path||[];
    renderNode(NODES[last.key],last.key);
    updateSelectedPath();
  }
};
document.getElementById("startOverBtn").onclick=()=>{
  path=[]; historyStack=[]; currentFinalRecommendation="";
  document.getElementById("selectedPath").textContent="No steps selected yet";
  document.getElementById("suggestedPanel").style.display="none";
  renderNode(NODES.cc_intro,"cc_intro");
};
document.getElementById("copyEmailBtn").onclick=()=>{
  navigator.clipboard.writeText(document.getElementById("suggestedEmail").innerText||"")
    .then(()=>alert("Email copied!")).catch(()=>alert("Copy failed"));
};

renderNode(NODES.cc_intro,"cc_intro");
</script>
</body>
</html>
